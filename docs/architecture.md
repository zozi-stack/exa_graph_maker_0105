# Architecture Documentation

> Auto-generated by BMAD Document Project workflow  
> Scan Level: Exhaustive  
> Generated: 2026-01-04

## Executive Summary

**Evals Plotter** is a single-page React application for creating and exporting evaluation bar charts and scatter plots. It features a canvas-based workspace where users can create multiple draggable charts, edit their data via a control panel, and export them as high-resolution PNG images.

---

## Architecture Overview

### Type
**Client-Side Single Page Application (SPA)**

### Pattern
**Component-Based Architecture** with D3.js Integration

### Key Characteristics
- No backend/API dependencies
- All state managed in React components
- D3.js for SVG chart rendering
- CSS Modules for scoped styling
- Vite for fast development and optimized builds

---

## System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        Browser Window                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                        App.tsx                              │ │
│  │  ┌─────────────────┐  ┌──────────────────────────────────┐ │ │
│  │  │  ControlPanel   │  │         Chart Canvas              │ │ │
│  │  │  ───────────    │  │  ┌────────────┐ ┌────────────┐   │ │ │
│  │  │  • Graph List   │  │  │ EvalChart  │ │ EvalChart  │   │ │ │
│  │  │  • Title Edit   │  │  │  (Graph 1) │ │  (Graph 2) │   │ │ │
│  │  │  • Data Edit    │◄─┼──┤  ┌──────┐  │ │  ┌──────┐  │   │ │ │
│  │  │  • Add/Remove   │  │  │  │Legend│  │ │  │Legend│  │   │ │ │
│  │  │  • Logo Upload  │  │  │  └──────┘  │ │  └──────┘  │   │ │ │
│  │  └────────┬────────┘  │  └────────────┘ └────────────┘   │ │ │
│  │           │           │           ▲ Drag & Drop           │ │ │
│  │           ▼           └───────────┼──────────────────────┘ │ │
│  │    onDataChange()                 │                        │ │
│  │           │                       │                        │ │
│  │           ▼                       │                        │ │
│  │    ┌──────────────────────────────┴─────────────────────┐  │ │
│  │    │                  React State                        │  │ │
│  │    │  • graphs: GraphWithPosition[]                      │  │ │
│  │    │  • activeGraphIndex: number                         │  │ │
│  │    │  • draggingIndex: number | null                     │  │ │
│  │    └────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   PNG Export     │
                    │ (dom-to-image)   │
                    └──────────────────┘
```

---

## Technology Stack

### Core Technologies

| Layer | Technology | Version | Purpose |
|-------|------------|---------|---------|
| UI Framework | React | 18.2.0 | Component rendering & state |
| Language | TypeScript | 5.2.2 | Type safety |
| Build Tool | Vite | 5.0.8 | Dev server, bundling, HMR |
| Data Visualization | D3.js | 7.9.0 | SVG chart generation |

### Supporting Libraries

| Library | Version | Purpose |
|---------|---------|---------|
| dom-to-image-more | 3.7.2 | High-quality PNG export |
| html2canvas | 1.4.1 | Fallback image capture |
| @types/d3 | 7.4.3 | D3 TypeScript definitions |

### Development Tools

| Tool | Version | Purpose |
|------|---------|---------|
| ESLint | 8.55.0 | Code linting |
| @vitejs/plugin-react | 4.2.1 | React Fast Refresh |
| typescript-eslint | 6.14.0 | TS-aware linting |

---

## Component Architecture

### Component Hierarchy

```
index.html
└── main.tsx (React entry)
    └── App.tsx (Root component)
        ├── ControlPanel.tsx (Editor sidebar)
        └── EvalChart.tsx (Chart renderer) ×N
            └── Legend.tsx (Chart legend)
```

### Component Responsibilities

| Component | Responsibility | State Owned |
|-----------|---------------|-------------|
| **App** | Layout, graph management, drag handling | graphs[], activeGraphIndex, draggingIndex |
| **ControlPanel** | Data editing UI, graph selection | expandedIndex (local UI state) |
| **EvalChart** | D3 rendering, export function | iconPositions (derived) |
| **Legend** | Display company icons/names | None (stateless) |

### Data Flow

```
                    ┌─────────────┐
                    │  evals.json │  (Initial data)
                    └──────┬──────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────┐
│                      App.tsx                              │
│  ┌────────────────────────────────────────────────────┐  │
│  │           graphs: GraphWithPosition[]               │  │
│  │  [{id, title, companies, posX, posY, ...}, ...]    │  │
│  └────────────────────────────────────────────────────┘  │
│        │                              │                   │
│        ▼                              ▼                   │
│  ┌─────────────┐              ┌─────────────────┐        │
│  │ControlPanel │◄────────────►│   EvalChart     │        │
│  │             │  onDataChange│                 │        │
│  │  Edit UI    │              │   D3 Render     │        │
│  └─────────────┘              └─────────────────┘        │
└──────────────────────────────────────────────────────────┘
```

---

## Rendering Architecture

### Dual SVG Layer System

EvalChart uses two overlapping SVGs for proper z-index control:

```
┌─────────────────────────────────────┐
│          Chart Container            │
│  ┌───────────────────────────────┐  │
│  │   gridSvgRef (z-index: 1)     │  │  ← Background layer
│  │   • Grid lines (dashed)       │  │
│  │   • Y-axis labels             │  │
│  │   • Dot grid (scatter)        │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   barsSvgRef (z-index: 10)    │  │  ← Foreground layer
│  │   • Bar rectangles            │  │
│  │   • Percentage labels         │  │
│  │   • Company names             │  │
│  │   • Axis lines                │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   HTML Icon Overlay           │  │  ← Icon layer (z-index: 15)
│  │   • <img> elements            │  │
│  │   • Positioned absolutely     │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### Why Dual Layers?
1. **Grid behind bars:** Dashed lines don't overlap bar fills
2. **Icons as HTML:** Better quality than SVG `<image>`, supports data URLs
3. **Clean export:** dom-to-image captures all layers correctly

---

## State Management

### State Architecture
**Pattern:** Lifted state with prop drilling

No external state management library (Redux, Zustand, etc.) is used. All state lives in `App.tsx` and is passed down via props.

### State Shape

```typescript
// App.tsx state
interface AppState {
  graphs: GraphWithPosition[];      // All charts on canvas
  activeGraphIndex: number;         // Currently selected chart
  draggingIndex: number | null;     // Chart being dragged
}

interface GraphWithPosition extends EvalData {
  posX: number;    // Canvas X position
  posY: number;    // Canvas Y position
}
```

### State Updates

| Action | Handler | Effect |
|--------|---------|--------|
| Edit chart data | `updateActiveGraph()` | Updates graphs[activeIndex] |
| Add chart | `addGraph(type)` | Appends to graphs[] |
| Remove chart | `removeGraph(index)` | Filters graphs[] |
| Select chart | `setActiveGraphIndex()` | Changes active |
| Drag chart | `handleMouseMove()` | Updates posX/posY |

---

## Styling Architecture

### CSS Strategy
**CSS Modules** for component-scoped styles

```
src/
├── index.css           # Global styles, font-faces, reset
├── App.css             # App layout, canvas styles
└── components/
    ├── EvalChart.module.css
    ├── ControlPanel.module.css
    ├── Legend.module.css
    └── ...
```

### Design Tokens

```css
/* Color Palette */
--color-primary: #3D3FEE;       /* Exa blue */
--color-neutral: #DFDFDF;       /* Default bar */
--color-background: #FAF9F7;    /* Chart bg */
--color-canvas: #F5F5F5;        /* Workspace */
--color-text: #000000;          /* Primary text */
--color-text-muted: #757575;    /* Labels */
--color-grid: #D0D0D0;          /* Grid lines */

/* Typography */
--font-display: 'ABC Arizona Flare', serif;
--font-body: 'ABC Diatype', sans-serif;
--font-mono: 'ABC Diatype Mono', monospace;

/* Spacing */
--chart-width: 640px;
--chart-height: 300px;
--margin-top: 15px;
--margin-right: 30px;
--margin-bottom: 50px;
--margin-left: 70px;
```

---

## Export Architecture

### PNG Export Flow

```
User clicks Export
        │
        ▼
┌───────────────────┐
│ Wait for fonts    │  await document.fonts.ready
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Delay 500ms       │  Ensure SVG text rendered
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ dom-to-image      │  Capture chartContentRef
│ .toPng()          │  with 4x scale
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Create <a> link   │  Trigger download
│ .click()          │
└───────────────────┘
```

### Export Configuration

```typescript
domtoimage.toPng(chartElement, {
  bgcolor: '#FAF9F7',
  scale: 4,           // High resolution
  quality: 1,         // Max quality
  style: {
    fontFamily: "'ABC Arizona Flare', serif"
  }
});
```

---

## Performance Considerations

### Current Optimizations
1. **React.StrictMode:** Catches side effects in dev
2. **CSS will-change:** Applied to draggable charts
3. **useCallback:** Memoized drag handlers
4. **Layered SVGs:** Prevents full re-render on interaction

### Potential Improvements
1. **React.memo:** Wrap EvalChart for graphs that haven't changed
2. **useMemo:** Memoize D3 scale calculations
3. **Virtual canvas:** For 10+ charts, consider virtualization
4. **Web Workers:** Move PNG generation off main thread

---

## Security Considerations

### Client-Side Only
- No sensitive data transmission
- No authentication required
- No API keys or secrets

### User-Uploaded Content
- Logo images converted to base64 data URLs
- Stored only in browser memory (React state)
- No server upload, no persistence

### Third-Party Dependencies
- All dependencies from npm registry
- No CDN scripts
- Fonts self-hosted in `public/`

---

## Browser Compatibility

### Target Browsers
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### Key Features Used
| Feature | Support |
|---------|---------|
| ES2020 | All targets |
| CSS Modules | Via Vite |
| SVG 1.1 | All targets |
| FileReader API | All targets |
| Blob URLs | All targets |

---

## Future Architecture Considerations

### If Adding Persistence
```
Option 1: LocalStorage
└── Serialize graphs[] to JSON
└── Load on app init

Option 2: Backend API
└── Add REST endpoints
└── User authentication
└── Database storage
```

### If Adding Collaboration
```
Option: WebSocket + CRDT
└── Real-time sync
└── Conflict resolution
└── Presence indicators
```

### If Scaling Chart Types
```
└── Abstract ChartRenderer interface
└── Plugin architecture
└── Lazy-loaded chart modules
```

